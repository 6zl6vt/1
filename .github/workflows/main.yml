name: 构建 Windows 可执行文件

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release_name:
        description: '发布名称'
        required: true
        default: '手动构建'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: 构建可执行文件
      run: |
        pyinstaller --onefile --windowed --name="AudioToOpusConverter" audio2opus_gui.py
        echo "构建完成，文件大小:"
        Get-ChildItem dist\AudioToOpusConverter.exe | ForEach-Object { 
          $sizeMB = $_.Length / 1MB
          Write-Host "文件大小: $($sizeMB.ToString('F2')) MB" 
        }
    
    - name: 创建便携版
      run: |
        mkdir -Force portable
        Copy-Item dist\AudioToOpusConverter.exe portable\
        if (Test-Path README.md) {
          Copy-Item README.md portable\
        }
        @"
注意: 此程序需要 ffmpeg 才能正常工作！
请从 https://ffmpeg.org/download.html 下载 ffmpeg
并将其添加到系统 PATH 环境变量中。

支持的输入格式:
- MP3, FLAC, WAV, AAC, M4A
- OGG, OPUS, WMA, APE 等

输出格式: OGG (Opus编码)

使用方法:
1. 运行 AudioToOpusConverter.exe
2. 选择输入文件或文件夹
3. 选择输出位置
4. 调整编码设置
5. 点击"开始转换"

编码参数说明:
- 比特率: 控制音频质量 (64k-320k)
- 编码质量: 0-10 (越高质量越好，转换越慢)
- VBR模式: 推荐开启以获得更好的质量/体积比
"@ | Out-File -FilePath portable\README.txt -Encoding UTF8
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: AudioToOpusConverter
        path: |
          dist/AudioToOpusConverter.exe
          portable/
        retention-days: 30
    
    - name: 创建 GitHub 发布版
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/AudioToOpusConverter.exe
          portable/README.txt
        generate_release_notes: true
        prerelease: false
